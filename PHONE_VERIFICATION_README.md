# سیستم تأیید شماره تلفن با ربات بله

## 📋 خلاصه

این سیستم امکان تأیید شماره تلفن کاربران از طریق ارسال کد 4 رقمی با ربات بله را فراهم می‌کند.

## 🔧 ویژگی‌های اضافه شده

### 1. سیستم تأیید شماره تلفن
- تولید کد تأیید 4 رقمی تصادفی
- ارسال کد از طریق ربات بله (خصوصی یا به مدیر)
- مهلت زمانی 10 دقیقه برای کد
- حداکثر 3 تلاش برای وارد کردن کد
- ذخیره موقت اطلاعات کاربر تا تأیید

### 2. API های جدید
- `POST /api/send-verification` - ارسال کد تأیید
- `POST /api/verify-and-register` - تأیید کد و ثبت‌نام نهایی

### 3. رابط کاربری بهبود یافته
- مرحله سوم برای وارد کردن کد تأیید
- نمایش پیشرفت 3 مرحله‌ای
- ورودی کد با فرمت مناسب
- پیام‌های راهنما و خطا

## 📁 فایل‌های جدید/تغییر یافته

```
robot/
├── data/
│   ├── verification_codes.json  # ذخیره کدهای تأیید موقت
│   └── workshops.json           # کارگاه‌های نمونه
├── gateway_bale.js             # API های جدید
src/
├── lib/
│   └── gateway.js              # توابع فراخوانی API
└── pages/
    └── Register.jsx            # صفحه ثبت‌نام بهبود یافته
test-verification.html          # فایل تست مستقل
```

## 🚀 نحوه استفاده

### 1. راه‌اندازی سرور
```bash
cd robot
npm start
# یا
node gateway_bale.js
```

### 2. راه‌اندازی React App
```bash
npm run dev
```

### 3. تست با فایل HTML
فایل `test-verification.html` را در مرورگر باز کنید.

## 📱 فرآیند کار

### مرحله 1: اطلاعات شخصی
کاربر نام، کد ملی (اختیاری) و شماره تلفن را وارد می‌کند.

### مرحله 2: انتخاب کارگاه
کاربر کارگاه مورد نظر را انتخاب می‌کند.

### مرحله 3: تأیید شماره تلفن
- سیستم کد 4 رقمی تولید می‌کند
- کد از طریق ربات بله ارسال می‌شود:
  - ابتدا سعی می‌کند مستقیماً به کاربر ارسال کند
  - اگر ناموفق بود، به مدیر ارسال می‌کند
- کاربر کد را وارد می‌کند
- پس از تأیید، ثبت‌نام کامل می‌شود

## 🔐 امنیت

- کدهای تأیید تصادفی 4 رقمی
- انقضای خودکار پس از 10 دقیقه
- محدودیت 3 تلاش برای هر کد
- حذف کد پس از استفاده موفق

## 📊 ذخیره‌سازی

### فایل verification_codes.json
```json
{
  "09123456789": {
    "code": "1234",
    "userData": {
      "firstName": "علی",
      "nationalId": "1234567890",
      "phone": "09123456789",
      "workshopId": "w_test_1"
    },
    "timestamp": 1640995200000,
    "attempts": 0,
    "verified": false
  }
}
```

### فایل registrations.json (پس از تأیید)
```json
[
  {
    "id": "r_1640995300000",
    "firstName": "علی",
    "nationalId": "1234567890",
    "phone": "09123456789",
    "workshopId": "w_test_1",
    "status": "verified",
    "ts": 1640995300000,
    "verifiedAt": 1640995300000
  }
]
```

## 🤖 پیام‌های ربات

### پیام کد تأیید
```
🔐 کد تأیید شما: *1234*

👤 نام: علی
📱 شماره: 09123456789
🏷️ کارگاه: کارگاه آموزش قرآن

⏰ این کد تا 10 دقیقه معتبر است.
🔄 لطفاً این کد را در سایت وارد کنید.
```

### پیام تأیید ثبت‌نام
```
✅ ثبت‌نام تأیید شده:
👤 نام: علی
📞 موبایل: 09123456789
🏷️ کارگاه: کارگاه آموزش قرآن
🆔 شناسه: r_1640995300000
⏰ زمان: ۱۴۰۴/۱۰/۱۵ ۱۴:۳۰
```

## 🧪 تست

### تست دستی
1. فایل `test-verification.html` را باز کنید
2. اطلاعات نمونه را وارد کنید
3. کد تأیید را از ربات دریافت کنید
4. کد را وارد کنید و ثبت‌نام را تکمیل کنید

### تست API با curl
```bash
# ارسال کد تأیید
curl -X POST http://localhost:3000/api/send-verification \
  -H "Content-Type: application/json" \
  -d '{"firstName":"علی تست","phone":"09123456789","workshopId":"w_test_1"}'

# تأیید کد
curl -X POST http://localhost:3000/api/verify-and-register \
  -H "Content-Type: application/json" \
  -d '{"phone":"09123456789","verificationCode":"1234"}'
```

## ⚠️ نکات مهم

1. **تنظیم ربات**: مطمئن شوید BOT_TOKEN در `robot/3config.js` تنظیم شده است
2. **دسترسی کاربران**: برای ارسال مستقیم، کاربران باید ابتدا با ربات ارتباط برقرار کرده باشند
3. **مدیر پشتیبان**: اگر ارسال مستقیم ناموفق باشد، کد به مدیر ارسال می‌شود
4. **پاک‌سازی**: کدهای منقضی شده خودکار پاک می‌شوند

## 🔧 تنظیمات قابل تغییر

در فایل `robot/gateway_bale.js`:
- مهلت زمانی کد: `10 * 60 * 1000` (10 دقیقه)
- تعداد تلاش‌ها: `3`
- ID مدیر: `ADMIN_ID`
- ID گروه گزارش: `REPORT_GROUP_ID`

