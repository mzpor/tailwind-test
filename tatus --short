warning: in the working copy of 'robot/settings_data.json', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/gateway-config.json', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/robot/gateway_bale.js b/robot/gateway_bale.js[m
[1mindex 2e0b8d2..b53ec15 100644[m
[1m--- a/robot/gateway_bale.js[m
[1m+++ b/robot/gateway_bale.js[m
[36m@@ -828,17 +828,19 @@[m [masync function sendCombinedDashboard() {[m
     const registrationIcon = registrationEnabled ? 'ğŸŸ¢' : 'ğŸ”´';[m
     const surveyIcon = surveyEnabled ? 'ğŸŸ¢' : 'ğŸ”´';[m
     [m
[31m-    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ø¨ÛŒÙ† Ù‡Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª[m
[32m+[m[32m    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ± Ø§Ø² Ø¨ÛŒÙ† Ù‡Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§[m
     let lastChangeInfo = 'Ù†Ø§Ù…Ø´Ø®Øµ';[m
     let latestTimestamp = null;[m
[31m-    let lastChangedSetting = '';[m
[32m+[m[32m    let lastChangedItem = '';[m
     let lastChangedFrom = '';[m
[32m+[m[32m    let lastChangedStatus = true;[m
     [m
     // Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§[m
     if (config.lastUpdate) {[m
       latestTimestamp = new Date(config.lastUpdate);[m
[31m-      lastChangedSetting = 'Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§';[m
[32m+[m[32m      lastChangedItem = 'Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§';[m
       lastChangedFrom = config.updatedFrom || 'Ø³ÛŒØ³ØªÙ…';[m
[32m+[m[32m      lastChangedStatus = config.enabled;[m
     }[m
     [m
     // Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ùˆ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…[m
[36m@@ -850,8 +852,9 @@[m [masync function sendCombinedDashboard() {[m
         const surveyTime = new Date(siteStatus.survey.lastUpdate);[m
         if (!latestTimestamp || surveyTime > latestTimestamp) {[m
           latestTimestamp = surveyTime;[m
[31m-          lastChangedSetting = 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ';[m
[32m+[m[32m          lastChangedItem = 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ';[m
           lastChangedFrom = siteStatus.survey.updatedFrom || 'Ø³ÛŒØ³ØªÙ…';[m
[32m+[m[32m          lastChangedStatus = surveyEnabled;[m
         }[m
       }[m
       [m
[36m@@ -860,22 +863,40 @@[m [masync function sendCombinedDashboard() {[m
         const registrationTime = new Date(siteStatus.registration.lastUpdate);[m
         if (!latestTimestamp || registrationTime > latestTimestamp) {[m
           latestTimestamp = registrationTime;[m
[31m-          lastChangedSetting = 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…';[m
[32m+[m[32m          lastChangedItem = 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…';[m
           lastChangedFrom = siteStatus.registration.updatedFrom || 'Ø³ÛŒØ³ØªÙ…';[m
[32m+[m[32m          lastChangedStatus = registrationEnabled;[m
         }[m
       }[m
     } catch (error) {[m
       console.log('âš ï¸ [COMBINED-DASHBOARD] Could not read site status for latest change time');[m
     }[m
     [m
[31m-    // ØªØ´Ø®ÛŒØµ Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ ØªÙ†Ø¸ÛŒÙ… Ùˆ ÙˆØ¶Ø¹ÛŒØª[m
[31m-    if (lastChangedSetting && lastChangedFrom) {[m
[31m-      let settingIcon = 'ğŸŸ¢';[m
[31m-      if (lastChangedSetting === 'Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ' && !surveyEnabled) settingIcon = 'ğŸ”´';[m
[31m-      if (lastChangedSetting === 'Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§' && !config.enabled) settingIcon = 'ğŸ”´';[m
[31m-      if (lastChangedSetting === 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…' && !registrationEnabled) settingIcon = 'ğŸ”´';[m
[32m+[m[32m    // Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§ (Ø±Ø¨Ø§ØªØŒ Ø§ØªØµØ§Ù„ØŒ Ø³Ø§ÛŒØª)[m
[32m+[m[32m    if (status.lastChange?.timestamp) {[m
[32m+[m[32m      const systemChangeTime = new Date(status.lastChange.timestamp);[m
[32m+[m[32m      if (!latestTimestamp || systemChangeTime > latestTimestamp) {[m
[32m+[m[32m        latestTimestamp = systemChangeTime;[m
[32m+[m[41m        [m
[32m+[m[32m        // ØªØ¹ÛŒÛŒÙ† Ù†Ø§Ù… Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…[m
[32m+[m[32m        const systemNames = {[m
[32m+[m[32m          robot: 'Ø±Ø¨Ø§Øª',[m
[32m+[m[32m          gateway: 'Ø§ØªØµØ§Ù„',[m[41m [m
[32m+[m[32m          website: 'Ø³Ø§ÛŒØª'[m
[32m+[m[32m        };[m
[32m+[m[41m        [m
[32m+[m[32m        lastChangedItem = systemNames[status.lastChange.system] || status.lastChange.system;[m
[32m+[m[32m        lastChangedFrom = 'Ø³ÛŒØ³ØªÙ…';[m
[32m+[m[32m        lastChangedStatus = status.lastChange.status;[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // ØªØ´Ø®ÛŒØµ Ø¢ÛŒÚ©ÙˆÙ† Ùˆ Ù…ØªÙ† Ù†Ù‡Ø§ÛŒÛŒ[m
[32m+[m[32m    if (lastChangedItem && lastChangedFrom) {[m
[32m+[m[32m      const statusIcon = lastChangedStatus ? 'ğŸŸ¢' : 'ğŸ”´';[m
[32m+[m[32m      const statusText = lastChangedStatus ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„';[m
       [m
[31m-      lastChangeInfo = `${settingIcon} ${lastChangedSetting} (${lastChangedFrom})`;[m
[32m+[m[32m      lastChangeInfo = `${statusIcon} ${lastChangedItem} ${statusText} (${lastChangedFrom})`;[m
     }[m
     [m
     // ÙØ±Ù…Øª Ø²Ù…Ø§Ù† ÙØ§Ø±Ø³ÛŒ[m
[36m@@ -901,8 +922,27 @@[m [m${registrationIcon} Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (${registrationUpdatedFrom})[m
 [m
 â° Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ: ${currentTime}`;[m
 [m
[31m-    await sendBaleMessage(REPORT_GROUP_ID, combinedMessage);[m
[31m-    console.log('âœ… [COMBINED] Combined dashboard sent');[m
[32m+[m[32m    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹ Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)[m
[32m+[m[32m    if (lastCombinedDashboardMessageId) {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const { deleteMessage } = require('./4bale');[m
[32m+[m[32m        await deleteMessage(REPORT_GROUP_ID, lastCombinedDashboardMessageId);[m
[32m+[m[32m        console.log('ğŸ—‘ï¸ [COMBINED] Previous combined dashboard deleted');[m
[32m+[m[32m      } catch (error) {[m
[32m+[m[32m        console.log('âš ï¸ [COMBINED] Could not delete previous dashboard:', error.message);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹ Ø¬Ø¯ÛŒØ¯[m
[32m+[m[32m    const sentMessage = await sendBaleMessage(REPORT_GROUP_ID, combinedMessage);[m
[32m+[m[41m    [m
[32m+[m[32m    // Ø°Ø®ÛŒØ±Ù‡ Ø´Ù†Ø§Ø³Ù‡ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø¯Ø± Ø¯ÙØ¹Ù‡ Ø¨Ø¹Ø¯[m
[32m+[m[32m    if (sentMessage && sentMessage.message_id) {[m
[32m+[m[32m      lastCombinedDashboardMessageId = sentMessage.message_id;[m
[32m+[m[32m      console.log('âœ… [COMBINED] Combined dashboard sent, message_id saved:', sentMessage.message_id);[m
[32m+[m[32m    } else {[m
[32m+[m[32m      console.log('âœ… [COMBINED] Combined dashboard sent (no message_id returned)');[m
[32m+[m[32m    }[m
   } catch (error) {[m
     console.error('âŒ [COMBINED] Error sending combined dashboard:', error);[m
   }[m
[36m@@ -918,6 +958,9 @@[m [mlet groupsCache = null;[m
 let groupsCacheTime = 0;[m
 const GROUPS_CACHE_DURATION = 5 * 60 * 1000; // 5 Ø¯Ù‚ÛŒÙ‚Ù‡[m
 [m
[32m+[m[32m// Ø´Ù†Ø§Ø³Ù‡ Ù¾ÛŒØ§Ù… Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹ Ø³ÛŒØ³ØªÙ… (Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ù‚Ø¨Ù„ÛŒ)[m
[32m+[m[32mlet lastCombinedDashboardMessageId = null;[m
[32m+[m
 // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡[m
 function getTimeAgo(timestamp) {[m
   try {[m
[36m@@ -1187,10 +1230,8 @@[m [masync function announceGatewayOnline(port) {[m
     // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Gateway[m
     updateSystemStatus('gateway', true);[m
     [m
[31m-    // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡[m
[31m-    await sendCombinedDashboard();[m
[31m-    [m
[31m-    console.log(`âœ… [GATEWAY] Gateway online - status updated`);[m
[32m+[m[32m    // Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªÙˆØ³Ø· Ø±Ø¨Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (robot/index.js)[m
[32m+[m[32m    console.log(`âœ… [GATEWAY] Gateway online - status updated (dashboard sent by robot)`);[m
   } catch (error) {[m
     console.error('âŒ [GATEWAY] Error announcing gateway online:', error);[m
   }[m
[1mdiff --git a/robot/settings_data.json b/robot/settings_data.json[m
[1mindex 6e96b18..0c2b644 100644[m
[1m--- a/robot/settings_data.json[m
[1m+++ b/robot/settings_data.json[m
[36m@@ -7,6 +7,6 @@[m
   "attendance_days": [[m
     5[m
   ],[m
[31m-  "enable_satisfaction_survey": false,[m
[32m+[m[32m  "enable_satisfaction_survey": true,[m
   "enable_bot_reports": true[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/lib/gateway-config.json b/src/lib/gateway-config.json[m
[1mindex b918030..a697bbc 100644[m
[1m--- a/src/lib/gateway-config.json[m
[1m+++ b/src/lib/gateway-config.json[m
[36m@@ -1,5 +1,5 @@[m
 {[m
   "gatewayPort": 3003,[m
   "gatewayUrl": "http://localhost:3003",[m
[31m-  "lastUpdate": "2025-08-09T21:45:58.779Z"[m
[32m+[m[32m  "lastUpdate": "2025-08-09T22:08:21.818Z"[m
 }[m
\ No newline at end of file[m
