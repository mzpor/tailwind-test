warning: in the working copy of 'robot/settings_data.json', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/gateway-config.json', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/robot/gateway_bale.js b/robot/gateway_bale.js[m
[1mindex 2e0b8d2..b53ec15 100644[m
[1m--- a/robot/gateway_bale.js[m
[1m+++ b/robot/gateway_bale.js[m
[36m@@ -828,17 +828,19 @@[m [masync function sendCombinedDashboard() {[m
     const registrationIcon = registrationEnabled ? '🟢' : '🔴';[m
     const surveyIcon = surveyEnabled ? '🟢' : '🔴';[m
     [m
[31m-    // محاسبه آخرین تغییر از بین همه تنظیمات[m
[32m+[m[32m    // محاسبه آخرین تغییر از بین همه تنظیمات و وضعیت سیستم‌ها[m
     let lastChangeInfo = 'نامشخص';[m
     let latestTimestamp = null;[m
[31m-    let lastChangedSetting = '';[m
[32m+[m[32m    let lastChangedItem = '';[m
     let lastChangedFrom = '';[m
[32m+[m[32m    let lastChangedStatus = true;[m
     [m
     // بررسی زمان تغییر گزارش‌ها[m
     if (config.lastUpdate) {[m
       latestTimestamp = new Date(config.lastUpdate);[m
[31m-      lastChangedSetting = 'گزارش‌ها';[m
[32m+[m[32m      lastChangedItem = 'گزارش‌ها';[m
       lastChangedFrom = config.updatedFrom || 'سیستم';[m
[32m+[m[32m      lastChangedStatus = config.enabled;[m
     }[m
     [m
     // بررسی زمان تغییر نظرسنجی و ثبت‌نام[m
[36m@@ -850,8 +852,9 @@[m [masync function sendCombinedDashboard() {[m
         const surveyTime = new Date(siteStatus.survey.lastUpdate);[m
         if (!latestTimestamp || surveyTime > latestTimestamp) {[m
           latestTimestamp = surveyTime;[m
[31m-          lastChangedSetting = 'نظرسنجی';[m
[32m+[m[32m          lastChangedItem = 'نظرسنجی';[m
           lastChangedFrom = siteStatus.survey.updatedFrom || 'سیستم';[m
[32m+[m[32m          lastChangedStatus = surveyEnabled;[m
         }[m
       }[m
       [m
[36m@@ -860,22 +863,40 @@[m [masync function sendCombinedDashboard() {[m
         const registrationTime = new Date(siteStatus.registration.lastUpdate);[m
         if (!latestTimestamp || registrationTime > latestTimestamp) {[m
           latestTimestamp = registrationTime;[m
[31m-          lastChangedSetting = 'ثبت‌نام';[m
[32m+[m[32m          lastChangedItem = 'ثبت‌نام';[m
           lastChangedFrom = siteStatus.registration.updatedFrom || 'سیستم';[m
[32m+[m[32m          lastChangedStatus = registrationEnabled;[m
         }[m
       }[m
     } catch (error) {[m
       console.log('⚠️ [COMBINED-DASHBOARD] Could not read site status for latest change time');[m
     }[m
     [m
[31m-    // تشخیص آیکون بر اساس نوع تنظیم و وضعیت[m
[31m-    if (lastChangedSetting && lastChangedFrom) {[m
[31m-      let settingIcon = '🟢';[m
[31m-      if (lastChangedSetting === 'نظرسنجی' && !surveyEnabled) settingIcon = '🔴';[m
[31m-      if (lastChangedSetting === 'گزارش‌ها' && !config.enabled) settingIcon = '🔴';[m
[31m-      if (lastChangedSetting === 'ثبت‌نام' && !registrationEnabled) settingIcon = '🔴';[m
[32m+[m[32m    // بررسی زمان تغییر وضعیت سیستم‌ها (ربات، اتصال، سایت)[m
[32m+[m[32m    if (status.lastChange?.timestamp) {[m
[32m+[m[32m      const systemChangeTime = new Date(status.lastChange.timestamp);[m
[32m+[m[32m      if (!latestTimestamp || systemChangeTime > latestTimestamp) {[m
[32m+[m[32m        latestTimestamp = systemChangeTime;[m
[32m+[m[41m        [m
[32m+[m[32m        // تعیین نام و وضعیت سیستم[m
[32m+[m[32m        const systemNames = {[m
[32m+[m[32m          robot: 'ربات',[m
[32m+[m[32m          gateway: 'اتصال',[m[41m [m
[32m+[m[32m          website: 'سایت'[m
[32m+[m[32m        };[m
[32m+[m[41m        [m
[32m+[m[32m        lastChangedItem = systemNames[status.lastChange.system] || status.lastChange.system;[m
[32m+[m[32m        lastChangedFrom = 'سیستم';[m
[32m+[m[32m        lastChangedStatus = status.lastChange.status;[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // تشخیص آیکون و متن نهایی[m
[32m+[m[32m    if (lastChangedItem && lastChangedFrom) {[m
[32m+[m[32m      const statusIcon = lastChangedStatus ? '🟢' : '🔴';[m
[32m+[m[32m      const statusText = lastChangedStatus ? 'فعال' : 'غیرفعال';[m
       [m
[31m-      lastChangeInfo = `${settingIcon} ${lastChangedSetting} (${lastChangedFrom})`;[m
[32m+[m[32m      lastChangeInfo = `${statusIcon} ${lastChangedItem} ${statusText} (${lastChangedFrom})`;[m
     }[m
     [m
     // فرمت زمان فارسی[m
[36m@@ -901,8 +922,27 @@[m [m${registrationIcon} ثبت‌نام (${registrationUpdatedFrom})[m
 [m
 ⏰ زمان فعلی: ${currentTime}`;[m
 [m
[31m-    await sendBaleMessage(REPORT_GROUP_ID, combinedMessage);[m
[31m-    console.log('✅ [COMBINED] Combined dashboard sent');[m
[32m+[m[32m    // حذف پیام داشبورد جامع قبلی (اگر وجود دارد)[m
[32m+[m[32m    if (lastCombinedDashboardMessageId) {[m
[32m+[m[32m      try {[m
[32m+[m[32m        const { deleteMessage } = require('./4bale');[m
[32m+[m[32m        await deleteMessage(REPORT_GROUP_ID, lastCombinedDashboardMessageId);[m
[32m+[m[32m        console.log('🗑️ [COMBINED] Previous combined dashboard deleted');[m
[32m+[m[32m      } catch (error) {[m
[32m+[m[32m        console.log('⚠️ [COMBINED] Could not delete previous dashboard:', error.message);[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // ارسال داشبورد جامع جدید[m
[32m+[m[32m    const sentMessage = await sendBaleMessage(REPORT_GROUP_ID, combinedMessage);[m
[32m+[m[41m    [m
[32m+[m[32m    // ذخیره شناسه پیام جدید برای حذف در دفعه بعد[m
[32m+[m[32m    if (sentMessage && sentMessage.message_id) {[m
[32m+[m[32m      lastCombinedDashboardMessageId = sentMessage.message_id;[m
[32m+[m[32m      console.log('✅ [COMBINED] Combined dashboard sent, message_id saved:', sentMessage.message_id);[m
[32m+[m[32m    } else {[m
[32m+[m[32m      console.log('✅ [COMBINED] Combined dashboard sent (no message_id returned)');[m
[32m+[m[32m    }[m
   } catch (error) {[m
     console.error('❌ [COMBINED] Error sending combined dashboard:', error);[m
   }[m
[36m@@ -918,6 +958,9 @@[m [mlet groupsCache = null;[m
 let groupsCacheTime = 0;[m
 const GROUPS_CACHE_DURATION = 5 * 60 * 1000; // 5 دقیقه[m
 [m
[32m+[m[32m// شناسه پیام آخرین داشبورد جامع سیستم (برای حذف پیام قبلی)[m
[32m+[m[32mlet lastCombinedDashboardMessageId = null;[m
[32m+[m
 // محاسبه زمان گذشته[m
 function getTimeAgo(timestamp) {[m
   try {[m
[36m@@ -1187,10 +1230,8 @@[m [masync function announceGatewayOnline(port) {[m
     // آپدیت وضعیت Gateway[m
     updateSystemStatus('gateway', true);[m
     [m
[31m-    // ارسال داشبورد ترکیبی به‌روزرسانی شده[m
[31m-    await sendCombinedDashboard();[m
[31m-    [m
[31m-    console.log(`✅ [GATEWAY] Gateway online - status updated`);[m
[32m+[m[32m    // داشبورد توسط ربات ارسال می‌شود (robot/index.js)[m
[32m+[m[32m    console.log(`✅ [GATEWAY] Gateway online - status updated (dashboard sent by robot)`);[m
   } catch (error) {[m
     console.error('❌ [GATEWAY] Error announcing gateway online:', error);[m
   }[m
[1mdiff --git a/robot/settings_data.json b/robot/settings_data.json[m
[1mindex 6e96b18..0c2b644 100644[m
[1m--- a/robot/settings_data.json[m
[1m+++ b/robot/settings_data.json[m
[36m@@ -7,6 +7,6 @@[m
   "attendance_days": [[m
     5[m
   ],[m
[31m-  "enable_satisfaction_survey": false,[m
[32m+[m[32m  "enable_satisfaction_survey": true,[m
   "enable_bot_reports": true[m
 }[m
\ No newline at end of file[m
[1mdiff --git a/src/lib/gateway-config.json b/src/lib/gateway-config.json[m
[1mindex b918030..a697bbc 100644[m
[1m--- a/src/lib/gateway-config.json[m
[1m+++ b/src/lib/gateway-config.json[m
[36m@@ -1,5 +1,5 @@[m
 {[m
   "gatewayPort": 3003,[m
   "gatewayUrl": "http://localhost:3003",[m
[31m-  "lastUpdate": "2025-08-09T21:45:58.779Z"[m
[32m+[m[32m  "lastUpdate": "2025-08-09T22:08:21.818Z"[m
 }[m
\ No newline at end of file[m
