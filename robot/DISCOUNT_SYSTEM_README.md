# 🎫 سیستم مدیریت تخفیف - راهنمای کامل

## 📋 **خلاصه سیستم**

سیستم تخفیف هوشمند برای کارگاه‌های قرآنی که 
امکان تولید، مدیریت و استفاده از کدهای تخفیف را فراهم می‌کند.

## 🚀 **قابلیت‌های اصلی**

### **برای مدیر:**
- 🎫 تولید کد تخفیف (مبلغ ثابت یا درصدی)
- 📋 مشاهده لیست کدهای فعال
- 📊 آمار و گزارش‌گیری
- 🚫 غیرفعال کردن کدها

### **برای کاربران:**
- 🎯 استفاده از کد تخفیف در ثبت‌نام
- 💰 مشاهده قیمت جدید پس از تخفیف
- ✅ پرداخت با مبلغ تخفیف خورده

## ⚙️ **قوانین سیستم**

### **محدودیت‌ها:**
- ⏰ **مدت اعتبار:** 10 روز
- 🔄 **تعداد استفاده:** 1 بار
- 👤 **محدودیت کاربر:** هر کد فقط برای یک کاربر
- 🎯 **انواع تخفیف:** مبلغ ثابت یا درصدی

### **مثال‌ها:**
```
/تولید_کد fixed 100000    # تخفیف 100,000 تومانی
/تولید_کد percentage 25   # تخفیف 25 درصدی
```

## 🔧 **نحوه استفاده**

### **1. تولید کد تخفیف (مدیر):**
```
🎫 تخفیف → تولید کد تخفیف → /تولید_کد [نوع] [مقدار]
```

### **2. استفاده از تخفیف (کاربر):**
```
ثبت‌نام کارگاه → 🎫 پرداخت با تخفیف → وارد کردن کد → تأیید پرداخت
```

### **3. مدیریت کدها (مدیر):**
```
🎫 تخفیف → 📋 لیست کدها → مشاهده کدهای فعال
🎫 تخفیف → 📊 آمار تخفیف → مشاهده آمار
```

## 📁 **فایل‌های سیستم**

### **فایل‌های اصلی:**
- `19discount.js` - ماژول مدیریت تخفیف
- `data/discount_codes.json` - ذخیره کدهای تخفیف
- `5polling.js` - پردازش دستورات و callback ها
- `15reg.js` - ادغام با فرآیند ثبت‌نام

### **ساختار داده:**
```json
{
  "discountCodes": {
    "ABC12345": {
      "code": "ABC12345",
      "type": "fixed",
      "value": 100000,
      "maxUsage": 1,
      "usedBy": [],
      "createdBy": "admin_id",
      "createdAt": "2025-01-16T...",
      "expiresAt": "2025-01-26T...",
      "isActive": true
    }
  }
}
```

## 🔄 **جریان کاری**

### **تولید کد:**
1. مدیر دستور `/تولید_کد` را اجرا می‌کند
2. سیستم کد 8 رقمی رندوم تولید می‌کند
3. کد با اطلاعات کامل ذخیره می‌شود
4. پیام تأیید به مدیر ارسال می‌شود

### **استفاده از کد:**
1. کاربر دکمه "پرداخت با تخفیف" را می‌زند
2. سیستم درخواست کد تخفیف می‌کند
3. کاربر کد را وارد می‌کند
4. سیستم کد را اعتبارسنجی می‌کند
5. در صورت معتبر بودن، تخفیف اعمال می‌شود
6. قیمت جدید نمایش داده می‌شود
7. کاربر می‌تواند پرداخت کند

## 🛡️ **امنیت و کنترل**

### **کنترل دسترسی:**
- فقط مدیر مدرسه می‌تواند کد تولید کند
- فقط مدیر مدرسه می‌تواند کدها را مدیریت کند
- کاربران فقط می‌توانند از کدهای معتبر استفاده کنند

### **اعتبارسنجی:**
- بررسی انقضای کد
- بررسی تعداد استفاده
- بررسی تکراری نبودن استفاده
- محاسبه خودکار قیمت جدید

## 📊 **گزارش‌گیری**

### **آمار موجود:**
- تعداد کل کدها
- تعداد کدهای فعال
- تعداد کدهای استفاده شده
- تعداد کدهای منقضی شده
- نرخ استفاده و فعال بودن

### **دستورات گزارش:**
```
/لیست_کدها      # نمایش کدهای فعال
/غیرفعال_کد     # غیرفعال کردن کد
```

## 🔧 **تنظیمات پیشرفته**

### **تغییر مدت اعتبار:**
در فایل `19discount.js` خط 47:
```javascript
expiresAt.setDate(expiresAt.getDate() + 10); // تغییر عدد 10
```

### **تغییر تعداد استفاده:**
در فایل `19discount.js` خط 58:
```javascript
maxUsage: 1, // تغییر عدد 1
```

## 🚨 **عیب‌یابی**

### **مشکلات رایج:**
1. **کد یافت نشد:** بررسی صحت کد و انقضای آن
2. **خطا در تولید:** بررسی دسترسی مدیر
3. **خطا در استفاده:** بررسی معتبر بودن کد

### **لاگ‌ها:**
تمام عملیات در کنسول لاگ می‌شوند:
```
🎫 [DISCOUNT] New discount code generated: ABC12345
🎯 [DISCOUNT] Discount code ABC12345 used by user 123456
```

## 📈 **بهبودهای آینده**

### **قابلیت‌های پیشنهادی:**
- 🎯 تخفیف‌های گروهی
- 📅 تخفیف‌های فصلی
- 🎁 تخفیف‌های ویژه
- 📊 گزارش‌های پیشرفته
- 🔗 ادغام با سیستم پرداخت واقعی

## 📞 **پشتیبانی**

برای سوالات و مشکلات:
1. بررسی لاگ‌های سیستم
2. بررسی فایل‌های داده
3. تست دستورات پایه
4. تماس با توسعه‌دهنده

---

**نسخه:** 1.0.0  
**تاریخ:** 1404/05/15  
**توسعه‌دهنده:** سیستم هوشمند ربات قرآنی
